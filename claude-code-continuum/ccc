#!/usr/bin/env bash
set -euo pipefail

# CCC - Claude Code Continuum Wrapper
# Manages Docker setup, credential mounting, and validation

VERSION="0.1.0"
CONTAINER_IMAGE="${CCC_IMAGE:-quay.io/jluhrsen/claude-code-continuum:latest}"
CONTAINER_USER="claude"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

error() {
    echo -e "${RED}❌ $1${NC}" >&2
}

info() {
    echo -e "${GREEN}✓ $1${NC}"
}

warn() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

# Validate setup before running
validate_setup() {
    # Check if continuum repo is configured
    if [[ -n "${CONTINUUM_REPO_URL:-}" ]]; then
        # User wants cloud sync, check for deploy key
        KEY_FILE="${CONTINUUM_KEY_PATH:-$HOME/.ssh/continuum_deploy_key}"

        if [[ ! -f "$KEY_FILE" ]]; then
            error "CONTINUUM_REPO_URL is set but deploy key not found!"
            echo ""
            echo "Setup instructions:"
            echo "  1. Create deploy key: ssh-keygen -t ed25519 -f ~/.ssh/continuum_deploy_key"
            echo "  2. Add public key (~/.ssh/continuum_deploy_key.pub) to GitHub repo settings"
            echo "  3. Run ccc again"
            echo ""
            echo "Alternatively, unset CONTINUUM_REPO_URL to use local-only mode."
            return 1
        fi

        info "Deploy key found: $KEY_FILE"
    else
        warn "CONTINUUM_REPO_URL not set - running in local-only mode"
        warn "Sessions will not sync across machines"
    fi

    return 0
}

# Detect container runtime
detect_runtime() {
    if command -v podman &>/dev/null; then
        echo "podman"
    elif command -v docker &>/dev/null; then
        echo "docker"
    else
        error "Neither podman nor docker found!"
        exit 1
    fi
}

# Build container run command with appropriate mounts
build_docker_cmd() {
    local docker_args=()
    local runtime
    runtime=$(detect_runtime)

    # Basic container setup
    docker_args+=(--rm -it)
    docker_args+=(--name "ccc-$$")

    # Container runs as UID 1000 (claude user) by default
    # If host user is also UID 1000, file ownership matches naturally

    # Mount current directory as /workspace (read-write)
    docker_args+=(-v "$(pwd):/workspace")
    docker_args+=(-w /workspace)

    # Note: .claude directory is NOT mounted - each container session is isolated
    # Session state is managed by the continuum vault, not host .claude state
    # /tmp is NOT mounted - container uses its own /tmp (avoids UID mapping issues)

    # Mount GCP Application Default Credentials file (read-only)
    # Will be copied to ~/.config/gcloud/application_default_credentials.json by session_manager.py
    GCLOUD_CREDS="$HOME/.config/gcloud/application_default_credentials.json"
    if [[ -f "$GCLOUD_CREDS" ]]; then
        docker_args+=(-v "$GCLOUD_CREDS:/gcp/creds.json:ro")
    fi

    # Mount SSH files to temp location for copying (will be copied by session_manager.py)
    if [[ -f "$HOME/.ssh/known_hosts" ]]; then
        docker_args+=(-v "$HOME/.ssh/known_hosts:/tmp/host-ssh/known_hosts:ro")
    fi

    # Mount continuum deploy key if configured (read-only)
    if [[ -n "${CONTINUUM_REPO_URL:-}" ]]; then
        KEY_FILE="${CONTINUUM_KEY_PATH:-$HOME/.ssh/continuum_deploy_key}"
        docker_args+=(-v "$KEY_FILE:/tmp/host-ssh/continuum_key:ro")
    fi

    # Pass through Claude-related env vars
    [[ -n "${CLAUDE_CODE_USE_VERTEX:-}" ]] && docker_args+=(-e CLAUDE_CODE_USE_VERTEX)
    [[ -n "${GCP_ID:-}" ]] && docker_args+=(-e GCP_ID)
    [[ -n "${CLOUD_ML_REGION:-}" ]] && docker_args+=(-e CLOUD_ML_REGION)
    [[ -n "${ANTHROPIC_API_KEY:-}" ]] && docker_args+=(-e ANTHROPIC_API_KEY)
    [[ -n "${ANTHROPIC_VERTEX_PROJECT_ID:-}" ]] && docker_args+=(-e ANTHROPIC_VERTEX_PROJECT_ID)

    # Pass through continuum repo URL
    [[ -n "${CONTINUUM_REPO_URL:-}" ]] && docker_args+=(-e CONTINUUM_REPO_URL)

    # Pass host system details for session metadata
    docker_args+=(-e "CCC_HOST_HOSTNAME=$(hostname)")
    docker_args+=(-e "CCC_HOST_KERNEL=$(uname -r)")

    echo "${docker_args[@]}"
}

# Main execution
main() {
    # Validate setup first
    if ! validate_setup; then
        exit 1
    fi

    # Handle --version flag
    if [[ "${1:-}" == "--version" ]]; then
        echo "ccc version $VERSION"
        exit 0
    fi

    # Handle --help flag
    if [[ "${1:-}" == "--help" ]]; then
        cat <<EOF
ccc - Claude Code Continuum

Usage: ccc [claude-options]

Environment Variables:
  CONTINUUM_REPO_URL        Git URL for session storage (optional)
  CONTINUUM_KEY_PATH        Path to deploy key (default: ~/.ssh/continuum_deploy_key)
  CCC_IMAGE                 Container image (default: quay.io/jluhrsen/claude-code-continuum:latest)
  CLAUDE_CODE_USE_VERTEX    Use Vertex AI (optional)
  GCP_ID                    GCP project ID (optional)
  CLOUD_ML_REGION           GCP region (optional)

Examples:
  ccc                                          # Start interactive session picker
  ccc --dangerously-skip-permissions -r        # Resume last session with auto-approve

For more info: https://github.com/jluhrsen/workBits/tree/main/claude-code-continuum
EOF
        exit 0
    fi

    # Build container command
    local docker_args
    docker_args=($(build_docker_cmd))

    # Detect runtime
    local runtime
    runtime=$(detect_runtime)

    # Run container
    echo "DEBUG: $runtime run ${docker_args[@]} $CONTAINER_IMAGE $@"
    exec "$runtime" run "${docker_args[@]}" "$CONTAINER_IMAGE" "$@"
}

main "$@"
